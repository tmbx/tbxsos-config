#!/bin/sh
# postinst script for tbxsos-config
#
# see: dh_installdeb(1)

set -e

. /usr/share/debconf/confmodule
db_version 2.0

case "$1" in
    configure)
        db_get tbxsos-config/web-passwd
        if [ "$RET" != "30" ] && ! grep -qc server.password /etc/teambox/tbxsosd/web.conf 2>/dev/null; then
            echo "server.password = \"${RET}\";" >> /etc/teambox/tbxsosd/web.conf
        fi

        # Build the configuration.
        [ ! -e /etc/apache2/sites-available/tbxsos-config ] && \
            apache2_build_conf \
                /usr/share/tbxsos-config/tbxsos-config.apache2.conf tbxsos-config 0 '*' 9000

        # Enable the site we are installing.
        [ ! -L /etc/apache2/sites-enabled/tbxsos-config ] && a2ensite tbxsos-config

        # Enable the Apache2 rewrite and SSL module.
        [ ! -L /etc/apache2/mods-enabled/rewrite.load ] && a2enmod rewrite 2>/dev/null
        [ ! -L /etc/apache2/mods-enabled/ssl.load ]     && a2enmod ssl 2>/dev/null

        # Required 'vendor' directory for Rails since we don't use Gems.
        [ ! -d /usr/share/tbxsos-config/www/vendor ] && \
            mkdir -p /usr/share/tbxsos-config/www/vendor/

        # Create the logfile since Rails is apparently too dumb to create it itself.
        [ ! -e /var/log/teambox/tbxsos-config.log ] && \
            touch /var/log/teambox/tbxsos-config.log && \
            chmod 0666 /var/log/teambox/tbxsos-config.log
        
        # Rename logfiles with outdated names.
        [ -e /var/log/teambox/config.log ] && \
            mv /var/log/teambox/config.log /var/log/teambox/tbxsos-configd.log
        [ -e /var/log/teambox/kpsapi.log ] && \
            mv /var/log/teambox/kpsapi.log /var/log/teambox/tbxsos-xmlrpc.log

        # Make the links in the 'vendor' directory for rails.
        for i in /usr/share/rails/*
        do
            if [ ! -L /usr/share/tbxsos-config/www/vendor/`basename $i` ]; then
                (cd /usr/share/tbxsos-config/www/vendor && ln -s $i `basename $i`)
            fi
        done
        [ ! -d /usr/share/tbxsos-config/www/vendor/rails ] && \
            (cd /usr/share/tbxsos-config/www/vendor && ln -s . rails)

        # We need to be able to write in this directory.
        chmod g+w /etc/teambox/act
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

db_stop

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
